name: Create Azure Storage Account

on:
  push:
    branches:
      - #main

jobs:
  create-storage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v1

    - name: Initialize Terraform
      run: terraform -chdir=infra init

    - name: Apply Terraform to create storage
      run: terraform -chdir=infra apply -auto-approve

    - name: Output storage account key
      id: storage-key
      run: echo "##[set-output name=storage_key;]$(terraform -chdir=infra output -raw storage_account_primary_access_key)"

    - name: Output storage account name
      id: storage-name
      run: echo "##[set-output name=storage_name;]$(terraform -chdir=infra output -raw storage_account_name)"

    - name: Output resource group name
      id: resource-group
      run: echo "##[set-output name=resource_group;]$(terraform -chdir=infra output -raw resource_group_name)"

    - name: Create storage key secret
      run: |
        curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             -H "Accept: application/vnd.github.v3+json" \
             https://api.github.com/repos/${{ github.repository }}/actions/secrets/AZURE_STORAGE_KEY \
             -d '{"encrypted_value":"${{ steps.storage-key.outputs.storage_key }}", "key_id":"${{ secrets.PUBLIC_KEY_ID }}"}'

    - name: Create storage account name secret
      run: |
        curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             -H "Accept: application/vnd.github.v3+json" \
             https://api.github.com/repos/${{ github.repository }}/actions/secrets/AZURE_STORAGE_ACCOUNT \
             -d '{"encrypted_value":"${{ steps.storage-name.outputs.storage_name }}", "key_id":"${{ secrets.PUBLIC_KEY_ID }}"}'

    - name: Create resource group name secret
      run: |
        curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             -H "Accept: application/vnd.github.v3+json" \
             https://api.github.com/repos/${{ github.repository }}/actions/secrets/AZURE_RESOURCE_GROUP \
             -d '{"encrypted_value":"${{ steps.resource-group.outputs.resource_group }}", "key_id":"${{ secrets.PUBLIC_KEY_ID }}"}'
